<div class="chat-room" *ngIf="room">
    <!-- En-tÃªte de la conversation -->
    <div class="room-header">
        <div class="avatar">
            <img *ngIf="room?.avatar" [src]="room?.avatar" alt="Avatar" />
            <div *ngIf="!room?.avatar" class="avatar-fallback">{{ getRoomInitials() }}</div>
        </div>
        <div class="room-info">
            <div class="room-title">
                <h3>{{ room?.name }}</h3>
                <span class="room-type">{{ room?.type === 'GROUP' ? 'Groupe' : 'Discussion privÃ©e' }}</span>
            </div>
            <div class="room-status">
                <span *ngIf="room?.description" class="room-description">{{ room?.description }}</span>
                <span class="last-seen">DerniÃ¨re activitÃ©: {{ room?.lastActivity | date:'short' }}</span>
            </div>
        </div>
    </div>

    <!-- Zone de messages -->
    <div class="messages-container" #messagesContainer>
        <div *ngIf="loading" class="loading-messages">
            <div class="spinner"></div>
            <span>Chargement des messages...</span>
        </div>

        <ng-container *ngFor="let msg of messages">
            <div class="message-row"
                 [ngClass]="{'mine': isMine(msg), 'other': !isMine(msg)}"
                 (click)="closeActionsMenu()">

                <!-- Avatar ou initiales de l'expÃ©diteur -->
                <div *ngIf="!isMine(msg)" class="sender-avatar">
                    <div class="sender-initials">{{ getSenderInitials(msg) }}</div>
                </div>

                <div class="message-content">
                    <div class="bubble"
                         (mouseenter)="showMessageActions(msg.id)"
                         (mouseleave)="hideMessageActions(msg.id)">

                        <!-- En-tÃªte du message -->
                        <div class="message-header">
              <span *ngIf="room?.type === 'GROUP' && !isMine(msg)" class="sender-name">
                {{ msg.senderName }}
              </span>
                            <span class="message-time">{{ msg.timestamp | date:'HH:mm' }}</span>
                            <span *ngIf="msg.isEdited" class="edited-badge">modifiÃ©</span>
                            <span *ngIf="isMine(msg)" class="message-status">
                <span *ngIf="msg.status === 'SENT'">âœ“</span>
                <span *ngIf="msg.status === 'DELIVERED'">âœ“âœ“</span>
                <span *ngIf="msg.status === 'READ'" class="read">âœ“âœ“</span>
              </span>
                        </div>

                        <!-- RÃ©fÃ©rence Ã  un message -->
                        <div *ngIf="msg.replyToId" class="reply-preview">
                            <div class="reply-line"></div>
                            <div class="reply-content">
                                <span class="reply-sender">{{ getReplySender(msg.replyToId) }}</span>
                                <span class="reply-text">{{ getReplyContent(msg.replyToId) }}</span>
                            </div>
                        </div>

                        <!-- Contenu du message -->
                        <div class="message-body">
                            <!-- Modification de message -->
                            <form *ngIf="editingMsgId === msg.id" (ngSubmit)="confirmEditMessage(msg)" class="edit-form">
                                <input [(ngModel)]="editedContent" name="editContent{{msg.id}}" required autocomplete="off"
                                       (keydown.escape)="cancelEditMessage()" />
                                <div class="edit-actions">
                                    <button type="submit" class="edit-confirm" title="Valider">âœ“</button>
                                    <button type="button" class="edit-cancel" (click)="cancelEditMessage()" title="Annuler">âœ•</button>
                                </div>
                            </form>

                            <!-- Message texte -->
                            <div *ngIf="msg.type === 'TEXT' && editingMsgId !== msg.id" class="text-content">
                                {{ msg.content }}
                            </div>

                            <!-- Message image -->
                            <div *ngIf="msg.type === 'IMAGE'" class="image-content">
                                <img [src]="getFileUrl(msg)" (click)="openImagePreview(msg.content)"
                                     alt="Image envoyÃ©e" class="message-image" />
                            </div>

                            <!-- Message fichier -->
                            <div *ngIf="msg.type === 'FILE' && !isImage(msg.content)" class="file-content">
                                <div class="file-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                        <polyline points="13 2 13 9 20 9"></polyline>
                                    </svg>
                                </div>
                                <div class="file-info">
                                    <span class="file-name">{{ msg.content }}</span>
                                    <a [href]="getFileUrl(msg)" download class="download-btn">TÃ©lÃ©charger</a>
                                </div>
                            </div>
                        </div>

                        <!-- Menu d'actions -->
                        <div class="message-actions" *ngIf="actionsMenuOpened === msg.id">
                            <button *ngIf="isMine(msg)" (click)="startEditMessage(msg); $event.stopPropagation()" class="action-btn" title="Modifier">
                                Modifier
                            </button>
                            <button *ngIf="isMine(msg)" (click)="deleteMessage(msg); $event.stopPropagation()" class="action-btn danger" title="Supprimer">
                                Supprimer
                            </button>
                            <button (click)="replyToMessage(msg); $event.stopPropagation()" class="action-btn" title="RÃ©pondre">
                                RÃ©pondre
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>
    </div>

    <!-- Barre de rÃ©ponse -->
    <div class="reply-bar" *ngIf="replyToMsg">
        <div class="reply-info">
            <span class="reply-label">RÃ©pondre Ã </span>
            <span class="reply-sender">{{ replyToMsg.senderName }}</span>
            <span class="reply-content">{{ replyToMsg.content.length > 30 ? (replyToMsg.content ) + '...' : replyToMsg.content }}</span>
        </div>
        <button (click)="cancelReply()" class="cancel-reply" title="Annuler la rÃ©ponse">
            âœ•
        </button>
    </div>

    <!-- Zone de saisie -->
    <div class="input-area">
        <div class="input-container">
            <label class="file-upload">
                <input type="file" (change)="onFileSelected($event)" accept="image/*, .pdf, .doc, .docx, .xls, .xlsx" />
                ðŸ“Ž
            </label>

            <div class="input-wrapper">
                <input type="text" placeholder="Ã‰crivez un message..." [(ngModel)]="messageContent"
                       (keyup.enter)="sendMessage()" (focus)="scrollToBottom()" />
                <div *ngIf="fileToSend" class="file-preview">
                    <span class="file-name">{{ fileToSend.name }}</span>
                    <button (click)="clearFile()" class="clear-file" title="Supprimer le fichier">
                        âœ•
                    </button>
                </div>
            </div>

            <button (click)="sendMessage()" [disabled]="!canSendMessage()" class="send-btn" title="Envoyer">
                {{ (!messageContent.trim() && !fileToSend) ? 'ðŸ˜Š' : 'âž¤' }}
            </button>
        </div>
    </div>

    <!-- PrÃ©visualisation d'image -->
    <div *ngIf="imagePreviewUrl" class="image-preview-overlay" (click)="closeImagePreview()">
        <div class="image-preview-container" (click)="$event.stopPropagation()">
            <img [src]="imagePreviewUrl" alt="PrÃ©visualisation" class="preview-image" />
            <button (click)="closeImagePreview()" class="close-preview" title="Fermer">
                âœ•
            </button>
        </div>
    </div>
</div>

<!-- Ã‰tat vide -->
<div *ngIf="!room" class="empty-state">
    <div class="empty-content">
        ðŸ’¬
        <h2>SÃ©lectionnez une discussion</h2>
        <p>Choisissez une conversation existante ou dÃ©marrez-en une nouvelle</p>
    </div>
</div>