<div class="chat-room" *ngIf="room">
    <!-- En-t√™te de la conversation -->
    <div class="room-header">
        <div class="avatar">
            <img *ngIf="room?.avatar" [src]="room?.avatar" alt="Avatar" />
            <div *ngIf="!room?.avatar" class="avatar-fallback">{{ getRoomInitials() }}</div>
        </div>
        <div class="room-info">
            <div class="room-title">
                <h3>{{ room?.name }}</h3>
                <span class="room-type">{{ room?.type === 'GROUP' ? 'Groupe' : 'Discussion priv√©e' }}</span>
            </div>
            <div class="room-status">
                <span *ngIf="room?.description" class="room-description">{{ room?.description }}</span>
                <span class="last-seen">Derni√®re activit√©: {{ room?.lastActivity | date:'short' }}</span>
            </div>
        </div>
        <div class="room-actions">
            <button class="action-btn" title="Rechercher">üîç</button>
            <button class="action-btn" title="Menu">‚ãÆ</button>
        </div>
    </div>

    <!-- Zone de messages -->
    <div class="messages-container" #messagesContainer>
        <div *ngIf="loading" class="loading-messages">
            <div class="spinner"></div>
            <span>Chargement des messages...</span>
        </div>

        <ng-container *ngFor="let msg of messages">
            <div class="message-row"
                 [ngClass]="{'mine': isMine(msg), 'other': !isMine(msg)}"
                 (click)="closeActionsMenu()">

                <!-- Avatar ou initiales de l'exp√©diteur -->
                <div *ngIf="!isMine(msg)" class="sender-avatar">
                    <img *ngIf="msg.senderAvatar" [src]="msg.senderAvatar" alt="Avatar" class="sender-avatar-img" />
                    <div *ngIf="!msg.senderAvatar" class="sender-initials">{{ getSenderInitials(msg) }}</div>
                </div>

                <div class="message-content">
                    <div class="bubble"
                         [ngClass]="{'image-bubble': isImageMessage(msg), 'file-bubble': isFileMessage(msg)}"
                         (mouseenter)="showMessageActions(msg.id)"
                         (mouseleave)="hideMessageActions(msg.id)">

                        <!-- En-t√™te du message -->
                        <div class="message-header" *ngIf="!isImageMessage(msg) || room?.type === 'GROUP'">
                            <span *ngIf="room?.type === 'GROUP' && !isMine(msg)" class="sender-name">
                                {{ msg.senderName }}
                            </span>
                            <span class="message-time">{{ msg.timestamp | date:'HH:mm' }}</span>
                            <span *ngIf="msg.isEdited" class="edited-badge">modifi√©</span>
                            <span *ngIf="isMine(msg)" class="message-status">
                                <span *ngIf="msg.status === 'SENT'">‚úì</span>
                                <span *ngIf="msg.status === 'DELIVERED'">‚úì‚úì</span>
                                <span *ngIf="msg.status === 'READ'" class="read">‚úì‚úì</span>
                            </span>
                        </div>

                        <!-- R√©f√©rence √† un message -->
                        <div *ngIf="msg.replyToId" class="reply-preview">
                            <div class="reply-line"></div>
                            <div class="reply-content">
                                <span class="reply-sender">{{ getReplySender(msg.replyToId) }}</span>
                                <span class="reply-text">{{ getReplyContent(msg.replyToId) }}</span>
                            </div>
                        </div>

                        <!-- Contenu du message -->
                        <div class="message-body">
                            <!-- Modification de message -->
                            <form *ngIf="editingMsgId === msg.id && msg.type === 'TEXT'"
                                  (ngSubmit)="confirmEditMessage(msg)" class="edit-form">
                                <input [(ngModel)]="editedContent" name="editContent{{msg.id}}" required autocomplete="off"
                                       (keydown.escape)="cancelEditMessage()" />
                                <div class="edit-actions">
                                    <button type="submit" class="edit-confirm" title="Valider">‚úì</button>
                                    <button type="button" class="edit-cancel" (click)="cancelEditMessage()" title="Annuler">‚úï</button>
                                </div>
                            </form>

                            <!-- Message texte -->
                            <div *ngIf="msg.type === 'TEXT' && editingMsgId !== msg.id" class="text-content">
                                <div class="text-message">{{ msg.content }}</div>
                                <!-- Timestamps pour messages texte -->
                                <div class="message-footer">
                                    <span class="message-time-footer">{{ msg.timestamp | date:'HH:mm' }}</span>
                                    <span *ngIf="msg.isEdited" class="edited-badge-footer">modifi√©</span>
                                    <span *ngIf="isMine(msg)" class="message-status-footer">
                                        <span *ngIf="msg.status === 'SENT'">‚úì</span>
                                        <span *ngIf="msg.status === 'DELIVERED'">‚úì‚úì</span>
                                        <span *ngIf="msg.status === 'READ'" class="read">‚úì‚úì</span>
                                    </span>
                                </div>
                            </div>

                            <!-- Message image -->
                            <div *ngIf="msg.type === 'IMAGE'" class="image-content">
                                <div class="image-wrapper" (click)="openImagePreview(getImageUrl(msg))">
                                    <img [src]="getImageUrl(msg)"
                                         [alt]="msg.fileName || 'Image envoy√©e'"
                                         class="message-image"
                                         (load)="onImageLoad()"
                                         (error)="onImageError($event)" />

                                    <!-- Overlay avec timestamp pour les images -->
                                    <div class="image-overlay">
                                        <div class="image-info">
                                            <span class="image-time">{{ msg.timestamp | date:'HH:mm' }}</span>
                                            <span *ngIf="isMine(msg)" class="image-status">
                                                <span *ngIf="msg.status === 'SENT'">‚úì</span>
                                                <span *ngIf="msg.status === 'DELIVERED'">‚úì‚úì</span>
                                                <span *ngIf="msg.status === 'READ'" class="read">‚úì‚úì</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Message vid√©o -->
                            <div *ngIf="msg.type === 'VIDEO'" class="video-content">
                                <div class="video-wrapper">
                                    <video [src]="getVideoUrl(msg)"
                                           controls
                                           preload="metadata"
                                           class="message-video"
                                           (click)="$event.stopPropagation()">
                                        Votre navigateur ne supporte pas la lecture vid√©o.
                                    </video>

                                    <!-- Overlay avec timestamp pour les vid√©os -->
                                    <div class="video-overlay">
                                        <div class="video-info">
                                            <span class="video-time">{{ msg.timestamp | date:'HH:mm' }}</span>
                                            <span *ngIf="isMine(msg)" class="video-status">
                                                <span *ngIf="msg.status === 'SENT'">‚úì</span>
                                                <span *ngIf="msg.status === 'DELIVERED'">‚úì‚úì</span>
                                                <span *ngIf="msg.status === 'READ'" class="read">‚úì‚úì</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="file-name" *ngIf="msg.fileName">{{ msg.fileName }}</div>
                            </div>

                            <!-- Message audio -->
                            <div *ngIf="msg.type === 'AUDIO'" class="audio-content">
                                <div class="audio-wrapper">
                                    <div class="audio-player">
                                        <button (click)="toggleAudioPlay(msg)" class="play-pause-btn">
                                            <span *ngIf="!isAudioPlaying(msg.id)">‚ñ∂Ô∏è</span>
                                            <span *ngIf="isAudioPlaying(msg.id)">‚è∏Ô∏è</span>
                                        </button>
                                        <audio #audioPlayer [src]="getAudioUrl(msg)"
                                               (ended)="onAudioEnded(msg.id)"
                                               (timeupdate)="onAudioTimeUpdate($event, msg.id)">
                                        </audio>
                                        <div class="audio-info">
                                            <span class="audio-duration">{{ getAudioDuration(msg.id) }}</span>
                                            <span class="file-name">{{ msg.fileName || 'Audio' }}</span>
                                        </div>
                                    </div>
                                    <div class="audio-footer">
                                        <span class="message-time">{{ msg.timestamp | date:'HH:mm' }}</span>
                                        <span *ngIf="isMine(msg)" class="message-status">
                                            <span *ngIf="msg.status === 'SENT'">‚úì</span>
                                            <span *ngIf="msg.status === 'DELIVERED'">‚úì‚úì</span>
                                            <span *ngIf="msg.status === 'READ'" class="read">‚úì‚úì</span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Message fichier -->
                            <div *ngIf="msg.type === 'FILE'" class="file-content">
                                <div class="file-wrapper">
                                    <div class="file-icon">
                                        <span class="file-type-icon">{{ getFileIcon(msg.mimeType) }}</span>
                                    </div>
                                    <div class="file-info">
                                        <span class="file-name">{{ msg.fileName || msg.content }}</span>
                                        <span class="file-size" *ngIf="msg.fileSize">{{ formatFileSize(msg.fileSize) }}</span>
                                        <a [href]="getFileUrl(msg)" download [download]="msg.fileName" class="download-btn">
                                            üì• T√©l√©charger
                                        </a>
                                    </div>
                                </div>
                                <div class="file-footer">
                                    <span class="message-time">{{ msg.timestamp | date:'HH:mm' }}</span>
                                    <span *ngIf="isMine(msg)" class="message-status">
                                        <span *ngIf="msg.status === 'SENT'">‚úì</span>
                                        <span *ngIf="msg.status === 'DELIVERED'">‚úì‚úì</span>
                                        <span *ngIf="msg.status === 'READ'" class="read">‚úì‚úì</span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Menu d'actions -->
                        <div class="message-actions" *ngIf="actionsMenuOpened === msg.id">
                            <button *ngIf="isMine(msg) && msg.type === 'TEXT'"
                                    (click)="startEditMessage(msg); $event.stopPropagation()"
                                    class="action-btn" title="Modifier">
                                ‚úèÔ∏è Modifier
                            </button>
                            <button *ngIf="isMine(msg)"
                                    (click)="deleteMessage(msg); $event.stopPropagation()"
                                    class="action-btn danger" title="Supprimer">
                                üóëÔ∏è Supprimer
                            </button>
                            <button (click)="replyToMessage(msg); $event.stopPropagation()"
                                    class="action-btn" title="R√©pondre">
                                ‚Ü©Ô∏è R√©pondre
                            </button>
                            <button *ngIf="msg.type === 'IMAGE' || msg.type === 'FILE'"
                                    (click)="downloadFile(msg); $event.stopPropagation()"
                                    class="action-btn" title="T√©l√©charger">
                                üì• T√©l√©charger
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>

        <!-- Indicateur de frappe -->
        <div *ngIf="someoneIsTyping" class="typing-indicator">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span class="typing-text">{{ typingUserName }} est en train d'√©crire...</span>
        </div>
    </div>

    <!-- Barre de r√©ponse -->
    <div class="reply-bar" *ngIf="replyToMsg">
        <div class="reply-info">
            <span class="reply-label">R√©pondre √†</span>
            <span class="reply-sender">{{ replyToMsg.senderName }}</span>
            <div class="reply-content">
                <span *ngIf="replyToMsg.type === 'TEXT'">{{ getReplyPreview(replyToMsg.content) }}</span>
                <span *ngIf="replyToMsg.type === 'IMAGE'">üñºÔ∏è Image</span>
                <span *ngIf="replyToMsg.type === 'VIDEO'">üé• Vid√©o</span>
                <span *ngIf="replyToMsg.type === 'AUDIO'">üéµ Audio</span>
                <span *ngIf="replyToMsg.type === 'FILE'">üìé {{ replyToMsg.fileName }}</span>
            </div>
        </div>
        <button (click)="cancelReply()" class="cancel-reply" title="Annuler la r√©ponse">‚úï</button>
    </div>

    <!-- Zone de saisie -->
    <div class="input-area">
        <!-- Pr√©visualisation de fichier -->
        <div *ngIf="fileToSend" class="file-preview-container">
            <div class="file-preview">
                <!-- Pr√©visualisation image -->
                <div *ngIf="isImageFile(fileToSend)" class="image-preview">
                    <img [src]="filePreviewUrl" alt="Pr√©visualisation" class="preview-image" />
                    <div class="preview-overlay">
                        <span class="preview-filename">{{ fileToSend.name }}</span>
                        <button (click)="clearFile()" class="remove-file-btn" title="Supprimer">‚ùå</button>
                    </div>
                </div>

                <!-- Pr√©visualisation autres fichiers -->
                <div *ngIf="!isImageFile(fileToSend)" class="file-preview-info">
                    <div class="file-preview-icon">{{ getFileTypeIcon(fileToSend.type) }}</div>
                    <div class="file-preview-details">
                        <span class="preview-filename">{{ fileToSend.name }}</span>
                        <span class="preview-filesize">{{ formatFileSize(fileToSend.size) }}</span>
                    </div>
                    <button (click)="clearFile()" class="remove-file-btn" title="Supprimer">‚ùå</button>
                </div>
            </div>
        </div>

        <div class="input-container">
            <!-- Boutons d'attachement -->
            <div class="attachment-buttons">
                <label class="file-upload-btn" title="Joindre un fichier">
                    <input type="file"
                           (change)="onFileSelected($event)"
                           accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar"
                           multiple="false" />
                    üìé
                </label>

                <label class="image-upload-btn" title="Envoyer une image">
                    <input type="file"
                           (change)="onImageSelected($event)"
                           accept="image/*" />
                    üñºÔ∏è
                </label>
            </div>

            <!-- Zone de texte -->
            <div class="input-wrapper">
                <input type="text"
                       placeholder="√âcrivez un message..."
                       [(ngModel)]="messageContent"
                       (keyup.enter)="sendMessage()"
                       (focus)="scrollToBottom()"
                       (input)="onTyping()"
                       [disabled]="isUploading"
                       class="message-input" />

                <!-- Indicateur d'upload -->
                <div *ngIf="isUploading" class="upload-progress">
                    <div class="upload-spinner"></div>
                    <span>Envoi en cours...</span>
                </div>
            </div>

            <!-- Bouton d'envoi -->
            <button (click)="sendMessage()"
                    [disabled]="!canSendMessage() || isUploading"
                    class="send-btn"
                    [ngClass]="{'has-content': canSendMessage()}"
                    title="Envoyer">
                <span *ngIf="!canSendMessage()">üòä</span>
                <span *ngIf="canSendMessage() && !isUploading">‚û§</span>
                <div *ngIf="isUploading" class="send-spinner"></div>
            </button>
        </div>
    </div>

    <!-- Pr√©visualisation d'image plein √©cran -->
    <div *ngIf="imagePreviewUrl" class="image-preview-overlay" (click)="closeImagePreview()">
        <div class="image-preview-modal" (click)="$event.stopPropagation()">
            <div class="image-preview-header">
                <div class="image-preview-info">
                    <span class="image-sender">{{ imagePreviewSender }}</span>
                    <span class="image-date">{{ imagePreviewDate | date:'dd/MM/yyyy √† HH:mm' }}</span>
                </div>
                <button (click)="closeImagePreview()" class="close-preview" title="Fermer">‚úï</button>
            </div>
            <div class="image-preview-content">
                <img [src]="imagePreviewUrl" alt="Pr√©visualisation" class="full-preview-image" />
            </div>
            <div class="image-preview-footer">
                <button *ngIf="imagePreviewDownload"
                        (click)="downloadImagePreview()"
                        class="download-preview-btn"
                        title="T√©l√©charger">
                    üì• T√©l√©charger
                </button>
            </div>
        </div>
    </div>
</div>

<!-- √âtat vide -->
<div *ngIf="!room" class="empty-state">
    <div class="empty-content">
        <div class="empty-icon">üí¨</div>
        <h2>S√©lectionnez une discussion</h2>
        <p>Choisissez une conversation existante ou d√©marrez-en une nouvelle</p>
    </div>
</div>