<div class="chat-container">
    <!-- Message d'erreur global -->
    <div *ngIf="error" class="error-message" (click)="clearError()">
        {{ error }} (Cliquer pour fermer)
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading">
        <mat-progress-spinner diameter="40"></mat-progress-spinner>
        Chargement...
    </div>

    <div class="chat-layout">
        <!-- SIDEBAR - Liste des chats -->
        <div class="sidebar">
            <h3>Mes Chats</h3>

            <!-- Bouton refresh -->
            <button (click)="loadUserChats()" class="btn btn-small" [disabled]="loading">
                üîÑ Actualiser
            </button>

            <!-- Bouton debug temporaire -->
            <button (click)="getCurrentUserId()" class="btn btn-small" style="background: orange; margin-top: 5px;">
                üêõ Debug User ID ({{currentUserId || 'NULL'}})
            </button>

            <!-- Liste des chats -->
            <div class="chat-list">
                <div *ngFor="let room of chatRooms"
                     class="chat-item"
                     [class.active]="selectedRoom?.id === room.id"
                     (click)="selectRoom(room)">
                    <div class="chat-avatar">
                        <div class="avatar-circle">
                            {{ getInitials(room.name) }}
                        </div>
                    </div>
                    <div class="chat-info">
                        <strong>{{ room.name }}</strong>
                        <div class="chat-meta">
                            <small>{{ formatDate(room.lastActivity) }}</small>
                            <span *ngIf="room.unreadCount && room.unreadCount > 0" class="unread-badge">
                                {{ room.unreadCount }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Message si aucun chat -->
                <div *ngIf="chatRooms.length === 0 && !loading" class="no-chats">
                    Aucun chat disponible
                </div>
            </div>

            <!-- CR√âATION DE CHATS -->
            <div class="chat-creation">
                <h4>Cr√©er Chat Priv√©</h4>
                <div class="form-group">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>ID utilisateur</mat-label>
                        <input matInput [(ngModel)]="otherUserId" placeholder="Ex: 123">
                    </mat-form-field>
                    <button mat-raised-button color="primary"
                            (click)="createPrivateChat()"
                            [disabled]="!otherUserId.trim()">
                        Cr√©er Chat
                    </button>
                </div>

                <h4>Cr√©er Groupe</h4>
                <div class="form-group">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Nom du groupe</mat-label>
                        <input matInput [(ngModel)]="groupName" placeholder="Mon groupe">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Description</mat-label>
                        <input matInput [(ngModel)]="groupDescription" placeholder="Description du groupe">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>IDs participants</mat-label>
                        <input matInput [(ngModel)]="participantIds" placeholder="1,2,3">
                    </mat-form-field>
                    <button mat-raised-button color="accent"
                            (click)="createGroup()"
                            [disabled]="!groupName.trim()">
                        Cr√©er Groupe
                    </button>
                </div>
            </div>
        </div>

        <!-- CONTENU PRINCIPAL -->
        <div class="main-content">
            <div *ngIf="!selectedRoom" class="no-selection">
                <mat-icon style="font-size: 48px; width: 48px; height: 48px;">chat</mat-icon>
                <h3>S√©lectionnez un chat pour commencer</h3>
                <p>Choisissez un chat dans la liste de gauche ou cr√©ez-en un nouveau.</p>
            </div>

            <div *ngIf="selectedRoom" class="chat-content">
                <!-- HEADER DU CHAT -->
                <div class="chat-header">
                    <div class="chat-title">
                        <div class="chat-avatar">
                            <div class="avatar-circle">
                                {{ getInitials(selectedRoom.name) }}
                            </div>
                        </div>
                        <div>
                            <h2>{{ selectedRoom.name }}</h2>
                            <div class="chat-meta">
                                <span class="chat-type-badge">{{ selectedRoom.type }}</span>
                                <span *ngIf="participants.length > 0" class="participant-count">
                                    {{ participants.length }} participant(s)
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button *ngIf="selectedRoom.type === 'GROUP'"
                                mat-button
                                (click)="addParticipant()"
                                [disabled]="!isGroupAdmin()">
                            <mat-icon>person_add</mat-icon>
                            Ajouter
                        </button>
                        <button *ngIf="selectedRoom.type === 'GROUP'"
                                mat-button color="warn"
                                (click)="leaveGroup()">
                            <mat-icon>exit_to_app</mat-icon>
                            Quitter
                        </button>
                    </div>
                </div>

                <!-- MESSAGES -->
                <div class="messages-container">
                    <div class="message-list" #messageContainer>
                        <!-- Message si aucun message -->
                        <div *ngIf="messages.length === 0" class="no-messages">
                            <mat-icon>chat_bubble_outline</mat-icon>
                            <p>Aucun message dans cette conversation</p>
                            <p>Soyez le premier √† envoyer un message !</p>
                        </div>

                        <!-- Messages -->
                        <div *ngFor="let message of messages; trackBy: trackMessage"
                             class="message-item"
                             [class.own-message]="message.senderId === currentUserId"
                             [class.other-message]="message.senderId !== currentUserId">

                            <!-- Avatar de l'exp√©diteur pour les messages re√ßus -->
                            <div *ngIf="message.senderId !== currentUserId" class="message-avatar">
                                <div class="avatar-circle small">
                                    {{ getInitials(message.senderName) }}
                                </div>
                            </div>

                            <div class="message-content">
                                <!-- Indicateur de r√©ponse (si replyToId existe) -->
                                <div *ngIf="message.replyToId" class="reply-indicator">
                                    <div class="reply-sender">R√©ponse √† {{ getRepliedMessageSender(message.replyToId) }}</div>
                                    <div class="reply-content">{{ getRepliedMessageContent(message.replyToId) }}</div>
                                </div>

                                <div class="message-bubble">
                                    <div class="message-header">
                                        <span class="sender-name">{{ message.senderName }}</span>
                                        <span class="message-time">{{ formatDate(message.timestamp) }}</span>
                                    </div>
                                    <div class="message-text">{{ message.content }}</div>
                                    <div class="message-footer">
                                        <span *ngIf="message.isEdited" class="edited-indicator">
                                            <mat-icon>edit</mat-icon> modifi√©
                                        </span>
                                        <span *ngIf="message.status" class="message-status">
                                            <mat-icon [class]="'status-' + message.status.toLowerCase()">
                                                {{ getStatusIcon(message.status) }}
                                            </mat-icon>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Avatar de l'exp√©diteur pour les messages envoy√©s -->
                            <div *ngIf="message.senderId === currentUserId" class="message-avatar">
                                <div class="avatar-circle small">
                                    {{ getInitials(message.senderName) }}
                                </div>
                            </div>

                            <!-- Menu d'actions -->
                            <div class="message-actions">
                                <button mat-icon-button
                                        class="message-actions-btn"
                                        (click)="toggleMessageMenu(message, $event)">
                                    <mat-icon>more_vert</mat-icon>
                                </button>

                                <!-- Menu contextuel corrig√© -->
                                <div class="message-context-menu" *ngIf="showMenuFor === message.id">
                                    <button (click)="replyToMessage(message)">
                                        <mat-icon>reply</mat-icon>
                                        <span>R√©pondre</span>
                                    </button>

                                    <!-- Debug info - √Ä supprimer apr√®s test -->
                                    <div style="font-size: 10px; color: #999; padding: 5px;"
                                         *ngIf="showMenuFor === message.id">
                                        Debug: currentUserId={{currentUserId}}, senderId={{message.senderId}},
                                        canEdit={{canEditMessage(message)}}
                                    </div>

                                    <button *ngIf="canEditMessage(message)"
                                            (click)="editMessage(message.id, message.content)">
                                        <mat-icon>edit</mat-icon>
                                        <span>Modifier</span>
                                    </button>

                                    <button *ngIf="canEditMessage(message)"
                                            (click)="deleteMessage(message.id)">
                                        <mat-icon>delete</mat-icon>
                                        <span>Supprimer</span>
                                    </button>

                                    <button (click)="copyMessage(message.content)">
                                        <mat-icon>content_copy</mat-icon>
                                        <span>Copier</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zone d'envoi de message -->
                    <div class="message-input-container">
                        <!-- Aper√ßu de la r√©ponse -->
                        <div *ngIf="replyingTo" class="reply-preview">
                            <span>R√©ponse √† {{ replyingTo.senderName }}:</span>
                            <span>{{ replyingTo.content }}</span>
                            <button mat-icon-button (click)="cancelReply()">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>

                        <mat-form-field appearance="outline" class="message-input-field">
                            <mat-label>Tapez votre message...</mat-label>
                            <textarea matInput
                                      [(ngModel)]="newMessage"
                                      (keydown)="onKeyDown($event)"
                                      [disabled]="sendingMessage"
                                      placeholder="Votre message..."
                                      cdkTextareaAutosize
                                      cdkAutosizeMinRows="1"
                                      cdkAutosizeMaxRows="4"></textarea>
                        </mat-form-field>

                        <button mat-fab color="primary"
                                (click)="sendMessage()"
                                [disabled]="!newMessage.trim() || sendingMessage"
                                class="send-button"
                                matTooltip="Envoyer le message (Enter)">
                            <mat-icon *ngIf="!sendingMessage">send</mat-icon>
                            <mat-progress-spinner *ngIf="sendingMessage"
                                                  diameter="24"
                                                  color="accent"></mat-progress-spinner>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>