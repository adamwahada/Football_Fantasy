<div class="chat-container">
    <!-- Message d'erreur global -->
    <div *ngIf="error" class="error-banner" (click)="clearError()">
        <mat-icon>warning</mat-icon>
        <span>{{ error }}</span>
        <mat-icon class="close-icon">close</mat-icon>
    </div>

    <!-- Loading overlay -->
    <div *ngIf="loading" class="loading-overlay">
        <div class="loading-content">
            <mat-progress-spinner diameter="40" color="primary"></mat-progress-spinner>
            <span>Chargement...</span>
        </div>
    </div>

    <div class="chat-layout">
        <!-- SIDEBAR - Liste des chats -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="header-content">
                    <h2>Messages</h2>
                    <div class="header-actions">
                        <button mat-icon-button (click)="loadUserChats()" [disabled]="loading"
                                matTooltip="Actualiser" class="refresh-btn">
                            <mat-icon>refresh</mat-icon>
                        </button>
                        <button mat-icon-button (click)="openNewChatModal()" matTooltip="Nouveau chat"
                                class="new-chat-btn">
                            <mat-icon>add_circle</mat-icon>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Barre de recherche -->
            <div class="search-bar">
                <div class="search-input">
                    <mat-icon class="search-icon">search</mat-icon>
                    <input placeholder="Rechercher une conversation..."
                           [(ngModel)]="searchQuery"
                           (input)="onSearchInput()"
                           class="search-field">
                </div>
            </div>

            <!-- Liste des chats -->
            <div class="chat-list">
                <div *ngFor="let room of chatRooms; trackBy: trackRoom"
                     class="chat-item"
                     [class.active]="selectedRoom?.id === room.id"
                     (click)="selectRoom(room)">

                    <div class="chat-avatar">
                        <div class="avatar-circle" [class]="'avatar-' + (room.type === 'GROUP' ? 'group' : 'private')">
                            <mat-icon *ngIf="room.type === 'GROUP'" class="group-icon">group</mat-icon>
                            <span *ngIf="room.type !== 'GROUP'" class="avatar-text">{{ getInitials(room.name) }}</span>
                        </div>
                        <div *ngIf="room.unreadCount && room.unreadCount > 0" class="unread-badge">
                            {{ room.unreadCount > 99 ? '99+' : room.unreadCount }}
                        </div>
                    </div>

                    <div class="chat-info">
                        <div class="chat-header-info">
                            <span class="chat-name">{{ room.name }}</span>
                            <span class="chat-time">{{ formatRelativeTime(room.lastActivity) }}</span>
                        </div>
                        <div class="chat-preview">
                            <span class="last-message">{{ getLastMessagePreview(room) }}</span>
                            <div class="chat-indicators">
                                <mat-icon *ngIf="room.type === 'GROUP'" class="group-indicator">group</mat-icon>
                                <div *ngIf="room.unreadCount && room.unreadCount > 0" class="unread-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message si aucun chat -->
                <div *ngIf="chatRooms.length === 0 && !loading" class="empty-state">
                    <mat-icon class="empty-icon">chat_bubble_outline</mat-icon>
                    <h3>Aucune conversation</h3>
                    <p>Créez votre première conversation</p>
                </div>
            </div>
        </div>

        <!-- CONTENU PRINCIPAL -->
        <div class="main-content">
            <!-- État vide - aucun chat sélectionné -->
            <div *ngIf="!selectedRoom" class="welcome-screen">
                <div class="welcome-content">
                    <div class="welcome-icon">
                        <mat-icon>chat</mat-icon>
                    </div>
                    <h2>Bienvenue dans votre messagerie</h2>
                    <p>Sélectionnez une conversation pour commencer à discuter</p>
                    <button mat-raised-button color="primary" (click)="openNewChatModal()" class="start-chat-btn">
                        <mat-icon>add</mat-icon>
                        Démarrer une conversation
                    </button>
                </div>
            </div>

            <!-- Interface de chat -->
            <div *ngIf="selectedRoom" class="chat-interface">
                <!-- HEADER DU CHAT -->
                <div class="chat-header">
                    <div class="chat-info-header">
                        <div class="chat-avatar-header">
                            <div class="avatar-circle large" [class]="'avatar-' + (selectedRoom.type === 'GROUP' ? 'group' : 'private')">
                                <mat-icon *ngIf="selectedRoom.type === 'GROUP'">group</mat-icon>
                                <span *ngIf="selectedRoom.type !== 'GROUP'">{{ getInitials(selectedRoom.name) }}</span>
                            </div>
                            <div class="status-indicator" *ngIf="selectedRoom.type !== 'GROUP'"></div>
                        </div>

                        <div class="header-text-info">
                            <h3 class="chat-title">{{ selectedRoom.name }}</h3>
                            <div class="chat-status">
                                <span class="participant-count" *ngIf="selectedRoom.type === 'GROUP'">
                                    {{ participants.length }} participants
                                </span>
                                <span class="online-status" *ngIf="selectedRoom.type === 'PRIVATE'">
                                    En ligne
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="header-actions">
                        <button mat-icon-button matTooltip="Rechercher">
                            <mat-icon>search</mat-icon>
                        </button>
                        <button *ngIf="selectedRoom.type === 'GROUP' && isGroupAdmin()"
                                mat-icon-button (click)="addParticipant()" matTooltip="Ajouter un participant">
                            <mat-icon>person_add</mat-icon>
                        </button>
                        <button mat-icon-button [matMenuTriggerFor]="chatMenu" matTooltip="Plus d'options">
                            <mat-icon>more_vert</mat-icon>
                        </button>
                    </div>
                </div>

                <!-- ZONE DES MESSAGES -->
                <div class="messages-container" #messageContainer (scroll)="onScroll($event)">
                    <!-- Indicateur de frappe -->
                    <div *ngIf="isSomeoneTyping()" class="typing-indicator">
                        <div class="typing-content">
                            <div class="typing-avatar">
                                <div class="avatar-circle mini">
                                    <mat-icon>person</mat-icon>
                                </div>
                            </div>
                            <div class="typing-bubble">
                                <span class="typing-text">{{ getTypingUserNames() }}</span>
                                <div class="typing-dots">
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div class="messages-list">
                        <div *ngIf="messages.length === 0 && !loading" class="no-messages">
                            <div class="no-messages-icon">
                                <mat-icon>chat_bubble_outline</mat-icon>
                            </div>
                            <h4>Aucun message</h4>
                            <p>Soyez le premier à envoyer un message dans cette conversation</p>
                        </div>

                        <!-- Messages avec alignement selon l'expéditeur -->
                        <div *ngFor="let message of messages; trackBy: trackMessage"
                             class="message-wrapper"
                             [class.own-message]="message.senderId === currentUserId"
                             [class.other-message]="message.senderId !== currentUserId">

                            <!-- Message des autres (à gauche) -->
                            <div *ngIf="message.senderId !== currentUserId" class="message-item received">
                                <!-- Avatar de l'expéditeur -->
                                <div class="message-avatar">
                                    <div class="avatar-circle mini">
                                        <span>{{ getInitials(getSenderName(message.senderId)) }}</span>
                                    </div>
                                </div>

                                <!-- Contenu du message -->
                                <div class="message-content">
                                    <!-- Contexte de réponse si présent -->
                                    <div *ngIf="message.replyToId" class="reply-context">
                                        <div class="reply-bar"></div>
                                        <div class="reply-info">
                                            <span class="reply-sender">{{ getRepliedMessageSender(message.replyToId) }}</span>
                                            <span class="reply-message">{{ getRepliedMessageContent(message.replyToId) }}</span>
                                        </div>
                                    </div>

                                    <!-- Bulle de message -->
                                    <div class="message-bubble received-bubble"
                                         [class.deleted-message]="isMessageDeleted(message)">
                                        <div class="message-header" *ngIf="selectedRoom?.type === 'GROUP'">
                                            <span class="sender-name">{{ getSenderName(message.senderId) }}</span>
                                        </div>

                                        <div class="message-text" *ngIf="!isMessageDeleted(message)">
                                            {{ message.content }}
                                        </div>
                                        <div class="message-text deleted-text" *ngIf="isMessageDeleted(message)">
                                            Ce message a été supprimé
                                        </div>

                                        <div class="message-meta">
                                            <span class="message-time">{{ formatDate(message.timestamp) }}</span>
                                            <span *ngIf="message.isEdited" class="edited-indicator">(modifié)</span>
                                        </div>
                                    </div>

                                    <!-- Actions pour messages des autres (limitées) -->
                                    <div class="message-actions" *ngIf="!isMessageDeleted(message)">
                                        <button mat-icon-button
                                                class="action-btn reply-btn"
                                                (click)="replyToMessage(message)"
                                                matTooltip="Répondre">
                                            <mat-icon>reply</mat-icon>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Mes messages (à droite) -->
                            <div *ngIf="message.senderId === currentUserId" class="message-item sent">
                                <!-- Contenu du message -->
                                <div class="message-content">
                                    <!-- Actions pour mes messages -->
                                    <div class="message-actions" *ngIf="!isMessageDeleted(message)">
                                        <button mat-icon-button
                                                class="action-btn reply-btn"
                                                (click)="replyToMessage(message)"
                                                matTooltip="Répondre">
                                            <mat-icon>reply</mat-icon>
                                        </button>
                                        <button mat-icon-button
                                                class="action-btn edit-btn"
                                                (click)="openEditModal(message)"
                                                matTooltip="Modifier">
                                            <mat-icon>edit</mat-icon>
                                        </button>
                                        <button mat-icon-button
                                                class="action-btn delete-btn"
                                                (click)="openDeleteConfirmModal(message.id)"
                                                matTooltip="Supprimer">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </div>

                                    <!-- Contexte de réponse si présent -->
                                    <div *ngIf="message.replyToId" class="reply-context">
                                        <div class="reply-bar"></div>
                                        <div class="reply-info">
                                            <span class="reply-sender">{{ getRepliedMessageSender(message.replyToId) }}</span>
                                            <span class="reply-message">{{ getRepliedMessageContent(message.replyToId) }}</span>
                                        </div>
                                    </div>

                                    <!-- Bulle de message -->
                                    <div class="message-bubble sent-bubble"
                                         [class.deleted-message]="isMessageDeleted(message)">
                                        <div class="message-text" *ngIf="!isMessageDeleted(message)">
                                            {{ message.content }}
                                        </div>
                                        <div class="message-text deleted-text" *ngIf="isMessageDeleted(message)">
                                            Vous avez supprimé ce message
                                        </div>

                                        <div class="message-meta">
                                            <span class="message-time">{{ formatDate(message.timestamp) }}</span>
                                            <span *ngIf="message.isEdited" class="edited-indicator">(modifié)</span>
                                            <mat-icon class="message-status"
                                                      [class]="'status-' + (message.status || 'sent')"
                                                      *ngIf="!isMessageDeleted(message)">
                                                {{ getStatusIcon(message.status) }}
                                            </mat-icon>
                                        </div>
                                    </div>
                                </div>

                                <!-- Avatar du destinataire (moi) -->
                                <div class="message-avatar">
                                    <div class="avatar-circle mini own">
                                        <span>{{ getInitials('Vous') }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ZONE DE SAISIE -->
                <div class="message-input-area">
                    <!-- Aperçu de la réponse -->
                    <div *ngIf="replyingTo" class="reply-preview">
                        <div class="reply-content">
                            <div class="reply-indicator"></div>
                            <div class="reply-details">
                                <span class="replying-to-label">Réponse à {{ getSenderName(replyingTo.senderId) }}</span>
                                <span class="replying-to-message">{{ replyingTo.content }}</span>
                            </div>
                        </div>
                        <button mat-icon-button (click)="cancelReply()" class="cancel-reply-btn">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>

                    <!-- Zone de saisie principale -->
                    <div class="input-area">
                        <div class="input-container">
                            <button mat-icon-button class="attach-btn" matTooltip="Joindre un fichier">
                                <mat-icon>attach_file</mat-icon>
                            </button>

                            <div class="text-input-wrapper">
                                <textarea placeholder="Tapez votre message..."
                                          [(ngModel)]="newMessage"
                                          (keydown)="onKeyDown($event)"
                                          (input)="onTyping()"
                                          [disabled]="sendingMessage"
                                          class="message-input"
                                          cdkTextareaAutosize
                                          cdkAutosizeMinRows="1"
                                          cdkAutosizeMaxRows="4"
                                          #messageTextarea></textarea>
                            </div>

                            <button class="send-btn"
                                    [disabled]="!newMessage.trim() || sendingMessage"
                                    (click)="sendMessage()"
                                    mat-icon-button>
                                <mat-icon *ngIf="!sendingMessage">send</mat-icon>
                                <mat-progress-spinner *ngIf="sendingMessage" diameter="20"></mat-progress-spinner>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu du chat -->
    <mat-menu #chatMenu="matMenu">
        <button mat-menu-item (click)="refreshCurrentRoom()">
            <mat-icon>refresh</mat-icon>
            <span>Actualiser</span>
        </button>
        <button mat-menu-item *ngIf="selectedRoom?.type === 'GROUP'" (click)="addParticipant()">
            <mat-icon>person_add</mat-icon>
            <span>Ajouter un participant</span>
        </button>
        <button mat-menu-item *ngIf="selectedRoom?.type === 'GROUP'" (click)="copyInviteLink()">
            <mat-icon>link</mat-icon>
            <span>Copier le lien d'invitation</span>
        </button>
        <button mat-menu-item *ngIf="selectedRoom?.type === 'GROUP'" (click)="leaveGroup()" class="danger-item">
            <mat-icon>exit_to_app</mat-icon>
            <span>Quitter le groupe</span>
        </button>
    </mat-menu>

    <!-- Modal pour créer un nouveau chat -->
    <div class="modal-overlay" *ngIf="showNewChatModal" (click)="closeNewChatModal()">
        <div class="new-chat-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Nouvelle conversation</h3>
                <button mat-icon-button (click)="closeNewChatModal()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <div class="modal-content">
                <div class="chat-type-selector">
                    <button class="type-option"
                            [class.active]="newChatType === 'private'"
                            (click)="newChatType = 'private'">
                        <mat-icon>person</mat-icon>
                        <span>Chat privé</span>
                    </button>
                    <button class="type-option"
                            [class.active]="newChatType === 'group'"
                            (click)="newChatType = 'group'">
                        <mat-icon>group</mat-icon>
                        <span>Groupe</span>
                    </button>
                </div>

                <!-- Formulaire chat privé -->
                <div *ngIf="newChatType === 'private'" class="chat-form">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>ID de l'utilisateur</mat-label>
                        <input matInput [(ngModel)]="otherUserId" placeholder="Entrez l'ID utilisateur" type="number">
                        <mat-icon matSuffix>person</mat-icon>
                    </mat-form-field>
                    <button mat-raised-button color="primary"
                            (click)="createPrivateChat(); closeNewChatModal()"
                            [disabled]="!otherUserId.trim() || loading"
                            class="create-btn">
                        <mat-icon>add</mat-icon>
                        Créer le chat
                    </button>
                </div>

                <!-- Formulaire groupe -->
                <div *ngIf="newChatType === 'group'" class="chat-form">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Nom du groupe</mat-label>
                        <input matInput [(ngModel)]="groupName" placeholder="Nom du groupe">
                        <mat-icon matSuffix>group</mat-icon>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Description (optionnelle)</mat-label>
                        <input matInput [(ngModel)]="groupDescription" placeholder="Description du groupe">
                        <mat-icon matSuffix>description</mat-icon>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>IDs des participants</mat-label>
                        <input matInput [(ngModel)]="participantIds" placeholder="1, 2, 3, ...">
                        <mat-hint>Séparez les IDs par des virgules</mat-hint>
                        <mat-icon matSuffix>people</mat-icon>
                    </mat-form-field>

                    <button mat-raised-button color="primary"
                            (click)="createGroup(); closeNewChatModal()"
                            [disabled]="!groupName.trim() || loading"
                            class="create-btn">
                        <mat-icon>group_add</mat-icon>
                        Créer le groupe
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de modification de message -->
    <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
        <div class="edit-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Modifier le message</h3>
                <button mat-icon-button (click)="closeEditModal()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <div class="modal-content">
                <div class="edit-form">
                    <div class="message-edit-area">
                        <textarea [(ngModel)]="editedMessageContent"
                                  placeholder="Modifiez votre message..."
                                  rows="4"
                                  #editTextarea></textarea>
                    </div>

                    <div class="form-actions">
                        <button class="cancel-btn" (click)="closeEditModal()">
                            Annuler
                        </button>
                        <button class="save-btn"
                                (click)="saveEditedMessage()"
                                [disabled]="!editedMessageContent?.trim() || editedMessageContent === messageToEdit?.content">
                            <mat-icon>save</mat-icon>
                            Enregistrer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de suppression -->
    <div class="modal-overlay" *ngIf="showDeleteConfirmModal">
        <div class="confirmation-modal">
            <div class="modal-icon danger">
                <mat-icon>warning</mat-icon>
            </div>
            <h3>Supprimer le message</h3>
            <p>Êtes-vous sûr de vouloir supprimer ce message ? Cette action ne peut pas être annulée.</p>

            <div class="modal-actions">
                <button class="cancel-btn" (click)="closeDeleteConfirmModal()">
                    Annuler
                </button>
                <button class="confirm-btn" (click)="confirmDeleteMessage()">
                    <mat-icon>delete</mat-icon>
                    Supprimer
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications Toast -->
    <div class="toast-container">
        <div *ngFor="let toast of toasts"
             class="toast"
             [class]="toast.type"
             [@slideIn]>
            <div class="toast-content">
                <mat-icon class="toast-icon">{{ toast.icon }}</mat-icon>
                <span class="toast-message">{{ toast.message }}</span>
                <button class="toast-close" (click)="removeToast(toast)">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </div>
    </div>
</div>