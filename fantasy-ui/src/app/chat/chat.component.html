<div class="chat-container">
    <!-- Message d'erreur global -->
    <div *ngIf="error" class="error-banner" (click)="clearError()">
        <mat-icon>warning</mat-icon>
        <span>{{ error }}</span>
        <mat-icon class="close-icon">close</mat-icon>
    </div>

    <!-- Loading overlay -->
    <div *ngIf="loading" class="loading-overlay">
        <div class="loading-content">
            <mat-progress-spinner diameter="40" color="primary"></mat-progress-spinner>
            <span>Chargement...</span>
        </div>
    </div>

    <div class="chat-layout">
        <!-- SIDEBAR - Liste des chats -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="header-content">
                    <h2>Messages</h2>
                    <div class="header-actions">
                        <button mat-icon-button (click)="loadUserChats()" [disabled]="loading"
                                matTooltip="Actualiser" class="refresh-btn">
                            <mat-icon>refresh</mat-icon>
                        </button>
                        <button mat-icon-button (click)="openNewChatModal()" matTooltip="Nouveau chat"
                                class="new-chat-btn">
                            <mat-icon>add_circle</mat-icon>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Barre de recherche -->
            <div class="search-bar">
                <div class="search-input">
                    <mat-icon class="search-icon">search</mat-icon>
                    <input placeholder="Rechercher une conversation..."
                           [(ngModel)]="searchQuery"
                           (input)="onSearchInput()"
                           class="search-field">
                </div>
            </div>

            <!-- Liste des chats -->
            <div class="chat-list">
                <div *ngFor="let room of chatRooms; trackBy: trackRoom"
                     class="chat-item"
                     [class.active]="selectedRoom?.id === room.id"
                     (click)="selectRoom(room)">

                    <div class="chat-avatar">
                        <div class="avatar-circle" [class]="'avatar-' + (room.type === 'GROUP' ? 'group' : 'private')">
                            <mat-icon *ngIf="room.type === 'GROUP'" class="group-icon">group</mat-icon>
                            <span *ngIf="room.type !== 'GROUP'" class="avatar-text">{{ getInitials(room.name) }}</span>
                        </div>
                        <div *ngIf="room.unreadCount && room.unreadCount > 0" class="unread-badge">
                            {{ room.unreadCount > 99 ? '99+' : room.unreadCount }}
                        </div>
                    </div>

                    <div class="chat-info">
                        <div class="chat-header-info">
                            <span class="chat-name">{{ room.name }}</span>
                            <span class="chat-time">{{ formatRelativeTime(room.lastActivity) }}</span>
                        </div>
                        <div class="chat-preview">
                            <span class="last-message">{{ getLastMessagePreview(room) }}</span>
                            <div class="chat-indicators">
                                <mat-icon *ngIf="room.type === 'GROUP'" class="group-indicator">group</mat-icon>
                                <div *ngIf="room.unreadCount && room.unreadCount > 0" class="unread-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message si aucun chat -->
                <div *ngIf="chatRooms.length === 0 && !loading" class="empty-state">
                    <mat-icon class="empty-icon">chat_bubble_outline</mat-icon>
                    <h3>Aucune conversation</h3>
                    <p>Créez votre première conversation</p>
                </div>
            </div>
        </div>

        <!-- CONTENU PRINCIPAL -->
        <div class="main-content">
            <!-- État vide - aucun chat sélectionné -->
            <div *ngIf="!selectedRoom" class="welcome-screen">
                <div class="welcome-content">
                    <div class="welcome-icon">
                        <mat-icon>chat</mat-icon>
                    </div>
                    <h2>Bienvenue dans votre messagerie</h2>
                    <p>Sélectionnez une conversation pour commencer à discuter</p>
                    <button mat-raised-button color="primary" (click)="openNewChatModal()" class="start-chat-btn">
                        <mat-icon>add</mat-icon>
                        Démarrer une conversation
                    </button>
                </div>
            </div>

            <!-- Interface de chat -->
            <div *ngIf="selectedRoom" class="chat-interface">
                <!-- HEADER DU CHAT -->
                <div class="chat-header">
                    <div class="chat-info-header">
                        <div class="chat-avatar-header">
                            <div class="avatar-circle large" [class]="'avatar-' + (selectedRoom.type === 'GROUP' ? 'group' : 'private')">
                                <mat-icon *ngIf="selectedRoom.type === 'GROUP'">group</mat-icon>
                                <span *ngIf="selectedRoom.type !== 'GROUP'">{{ getInitials(selectedRoom.name) }}</span>
                            </div>
                            <div class="status-indicator" *ngIf="selectedRoom.type !== 'GROUP'"></div>
                        </div>

                        <div class="header-text-info">
                            <h3 class="chat-title">{{ selectedRoom.name }}</h3>
                            <div class="chat-status">
                                <span class="participant-count" *ngIf="selectedRoom.type === 'GROUP'">
                                    {{ participants.length }} participants
                                </span>
                                <span class="online-status" *ngIf="selectedRoom.type === 'PRIVATE'">
                                    En ligne
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="header-actions">
                        <button mat-icon-button matTooltip="Rechercher">
                            <mat-icon>search</mat-icon>
                        </button>
                        <button *ngIf="selectedRoom.type === 'GROUP' && isGroupAdmin()"
                                mat-icon-button (click)="addParticipant()" matTooltip="Ajouter un participant">
                            <mat-icon>person_add</mat-icon>
                        </button>
                        <button mat-icon-button [matMenuTriggerFor]="chatMenu" matTooltip="Plus d'options">
                            <mat-icon>more_vert</mat-icon>
                        </button>
                    </div>
                </div>

                <!-- ZONE DES MESSAGES -->
                <div class="messages-container" #messageContainer (scroll)="onScroll($event)">
                    <!-- Indicateur de frappe -->
                    <div *ngIf="isSomeoneTyping()" class="typing-indicator">
                        <span>{{ getTypingUserNames() }}</span>
                        <div class="typing-dots">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div class="messages-wrapper">
                        <div class="messages-list">
                            <!-- Messages -->
                            <div *ngFor="let message of messages; let i = index; trackBy: trackMessage"
                                 class="message-wrapper"
                                 [class.sent]="isSentByCurrentUser(message)"
                                 [class.received]="!isSentByCurrentUser(message)"
                                 [class.same-sender]="i > 0 && messages[i-1].senderId === message.senderId"
                                 (mouseenter)="setMessageShowState(message.id, true)"
                                 (mouseleave)="setMessageShowState(message.id, false)">

                                <!-- Message reçu (aligné à gauche) -->
                                <div *ngIf="!isSentByCurrentUser(message)" class="message-container received-message">
                                    <!-- Avatar -->
                                    <div class="message-avatar"
                                         [style.visibility]="shouldShowAvatar(i) ? 'visible' : 'hidden'">
                                        <div class="avatar-circle mini">
                                            {{ getInitials(message.senderName || 'U') }}
                                        </div>
                                    </div>

                                    <!-- Contenu du message -->
                                    <div class="message-content">
                                        <!-- Nom de l'expéditeur pour les groupes -->
                                        <div *ngIf="selectedRoom?.type === 'GROUP' && shouldShowSenderName(i)"
                                             class="sender-name">
                                            {{ message.senderName }}
                                        </div>

                                        <!-- Bulle du message -->
                                        <div class="message-bubble received-bubble">
                                            <!-- Contenu texte -->
                                            <div *ngIf="message.content && message.type === 'TEXT'" class="message-text">
                                                {{ message.content }}
                                            </div>

                                            <!-- Contenu fichier -->
                                            <div *ngIf="message.type === 'FILE'" class="message-file">
                                                <!-- Image -->
                                                <div *ngIf="isImageFile(getMessageFileName(message))" class="image-message">
                                                    <img [src]="getFileUrl(getMessageFileName(message))"
                                                         [alt]="getOriginalFileName(getMessageFileName(message))"
                                                         (click)="openImagePreview(getMessageFileName(message))"
                                                         (error)="onImageError($event)"
                                                         class="message-image">
                                                </div>

                                                <!-- Autre fichier -->
                                                <div *ngIf="!isImageFile(getMessageFileName(message))" class="file-attachment">
                                                    <div class="file-info">
                                                        <mat-icon class="file-icon">{{ getFileIcon(getMessageFileName(message)) }}</mat-icon>
                                                        <div class="file-details">
                                                            <span class="file-name">{{ getOriginalFileName(getMessageFileName(message)) }}</span>
                                                            <span class="file-size">{{ getFileSize(getMessageFileName(message)) }}</span>
                                                        </div>
                                                    </div>
                                                    <button mat-icon-button (click)="downloadFile(getMessageFileName(message))">
                                                        <mat-icon>download</mat-icon>
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Métadonnées -->
                                            <div class="message-meta">
                                                <span class="message-time">{{ formatDate(message.timestamp) }}</span>
                                                <span *ngIf="message.isEdited" class="edited-indicator">modifié</span>
                                            </div>
                                        </div>

                                        <!-- Actions du message -->
                                        <div class="message-actions"
                                             [class.show]="getMessageShowState(message.id) || showMenuFor === message.id">
                                            <button mat-icon-button
                                                    class="action-btn"
                                                    (click)="toggleMessageMenu(message, $event)">
                                                <mat-icon>more_vert</mat-icon>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Message envoyé (aligné à droite) -->
                                <div *ngIf="isSentByCurrentUser(message)" class="message-container sent-message">
                                    <!-- Contenu du message -->
                                    <div class="message-content">
                                        <!-- Bulle du message -->
                                        <div class="message-bubble sent-bubble">
                                            <!-- Contenu texte -->
                                            <div *ngIf="message.content && message.type === 'TEXT'" class="message-text">
                                                {{ message.content }}
                                            </div>

                                            <!-- Contenu fichier -->
                                            <div *ngIf="message.type === 'FILE'" class="message-file">
                                                <!-- Image -->
                                                <div *ngIf="isImageFile(getMessageFileName(message))" class="image-message">
                                                    <img [src]="getFileUrl(getMessageFileName(message))"
                                                         [alt]="getOriginalFileName(getMessageFileName(message))"
                                                         (click)="openImagePreview(getMessageFileName(message))"
                                                         (error)="onImageError($event)"
                                                         class="message-image">
                                                </div>

                                                <!-- Autre fichier -->
                                                <div *ngIf="!isImageFile(getMessageFileName(message))" class="file-attachment">
                                                    <div class="file-info">
                                                        <mat-icon class="file-icon">{{ getFileIcon(getMessageFileName(message)) }}</mat-icon>
                                                        <div class="file-details">
                                                            <span class="file-name">{{ getOriginalFileName(getMessageFileName(message)) }}</span>
                                                            <span class="file-size">{{ getFileSize(getMessageFileName(message)) }}</span>
                                                        </div>
                                                    </div>
                                                    <button mat-icon-button (click)="downloadFile(getMessageFileName(message))">
                                                        <mat-icon>download</mat-icon>
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Métadonnées -->
                                            <div class="message-meta">
                                                <span class="message-time">{{ formatDate(message.timestamp) }}</span>
                                                <span *ngIf="message.isEdited" class="edited-indicator">modifié</span>
                                                <mat-icon class="status-icon">{{ getMessageStatusIcon(message) }}</mat-icon>
                                            </div>
                                        </div>

                                        <!-- Actions du message -->
                                        <div class="message-actions"
                                             [class.show]="getMessageShowState(message.id) || showMenuFor === message.id">
                                            <button mat-icon-button
                                                    class="action-btn"
                                                    (click)="toggleMessageMenu(message, $event)">
                                                <mat-icon>more_vert</mat-icon>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Avatar -->
                                    <div class="message-avatar"
                                         [style.visibility]="shouldShowAvatar(i) ? 'visible' : 'hidden'">
                                        <div class="avatar-circle mini own">
                                            {{ getInitials(message.senderName || 'Moi') }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Menu contextuel -->
                                <div *ngIf="showMenuFor === message.id"
                                     class="message-menu"
                                     [class.sent-menu]="isSentByCurrentUser(message)"
                                     [class.received-menu]="!isSentByCurrentUser(message)">

                                    <button class="menu-option" (click)="replyToMessage(message)">
                                        <mat-icon>reply</mat-icon>
                                        <span>Répondre</span>
                                    </button>

                                    <button class="menu-option" (click)="copyMessage(message.content)">
                                        <mat-icon>content_copy</mat-icon>
                                        <span>Copier</span>
                                    </button>

                                    <button *ngIf="canEditMessage(message)"
                                            class="menu-option"
                                            (click)="openEditModal(message)">
                                        <mat-icon>edit</mat-icon>
                                        <span>Modifier</span>
                                    </button>

                                    <button *ngIf="canEditMessage(message)"
                                            class="menu-option danger"
                                            (click)="openDeleteConfirmModal(message.id)">
                                        <mat-icon>delete</mat-icon>
                                        <span>Supprimer</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ZONE DE SAISIE -->
                <div class="message-input-area">
                    <!-- Aperçu de la réponse -->
                    <div *ngIf="replyingTo" class="reply-preview">
                        <div class="reply-content">
                            <div class="reply-indicator"></div>
                            <div class="reply-details">
                                <span class="replying-to-label">Réponse à {{ replyingTo.senderName }}</span>
                                <span class="replying-to-message">{{ replyingTo.content }}</span>
                            </div>
                        </div>
                        <button mat-icon-button (click)="cancelReply()" class="cancel-reply-btn">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>

                    <!-- Zone de saisie principale -->
                    <div class="input-area">
                        <div class="input-container">
                            <!-- Bouton d'attachement avec menu -->
                            <button mat-icon-button class="attach-btn" [matMenuTriggerFor]="attachMenu"
                                    matTooltip="Joindre un fichier">
                                <mat-icon>attach_file</mat-icon>
                            </button>

                            <!-- Menu d'attachement -->
                            <mat-menu #attachMenu="matMenu" class="attach-menu">
                                <button mat-menu-item (click)="fileInput.click()">
                                    <mat-icon>insert_drive_file</mat-icon>
                                    <span>Document</span>
                                </button>
                                <button mat-menu-item (click)="imageInput.click()">
                                    <mat-icon>image</mat-icon>
                                    <span>Image</span>
                                </button>
                            </mat-menu>

                            <!-- Inputs cachés pour les fichiers -->
                            <input #fileInput type="file" style="display: none"
                                   (change)="onFileSelected($event)"
                                   accept=".pdf,.doc,.docx,.txt,.xlsx,.xls,.ppt,.pptx">
                            <input #imageInput type="file" style="display: none"
                                   (change)="onFileSelected($event)"
                                   accept="image/*">

                            <div class="text-input-wrapper">
                                <textarea placeholder="Tapez votre message..."
                                          [(ngModel)]="newMessage"
                                          (keydown)="onKeyDown($event)"
                                          (input)="onTyping()"
                                          [disabled]="sendingMessage"
                                          class="message-input"
                                          cdkTextareaAutosize
                                          cdkAutosizeMinRows="1"
                                          cdkAutosizeMaxRows="4"
                                          #messageTextarea></textarea>
                            </div>

                            <button class="send-btn"
                                    [disabled]="(!newMessage.trim() && !selectedFile) || sendingMessage"
                                    (click)="sendMessage()"
                                    mat-icon-button>
                                <mat-icon *ngIf="!sendingMessage">send</mat-icon>
                                <mat-progress-spinner *ngIf="sendingMessage" diameter="20"></mat-progress-spinner>
                            </button>
                        </div>

                        <!-- Prévisualisation de fichier sélectionné -->
                        <div *ngIf="selectedFile" class="file-preview">
                            <div class="file-preview-info">
                                <mat-icon class="file-preview-icon">{{ getFileIcon(selectedFile.name) }}</mat-icon>
                                <div class="file-preview-details">
                                    <span class="file-preview-name">{{ selectedFile.name }}</span>
                                    <span class="file-preview-size">{{ formatFileSize(selectedFile.size) }}</span>
                                </div>
                            </div>
                            <button mat-icon-button class="remove-file-btn"
                                    (click)="removeSelectedFile()"
                                    matTooltip="Retirer le fichier">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu du chat -->
    <mat-menu #chatMenu="matMenu">
        <button mat-menu-item (click)="refreshCurrentRoom()">
            <mat-icon>refresh</mat-icon>
            <span>Actualiser</span>
        </button>
        <button mat-menu-item *ngIf="selectedRoom?.type === 'GROUP'" (click)="addParticipant()">
            <mat-icon>person_add</mat-icon>
            <span>Ajouter un participant</span>
        </button>
        <button mat-menu-item *ngIf="selectedRoom?.type === 'GROUP'" (click)="copyInviteLink()">
            <mat-icon>link</mat-icon>
            <span>Copier le lien d'invitation</span>
        </button>
        <button mat-menu-item *ngIf="selectedRoom?.type === 'GROUP'" (click)="leaveGroup()" class="danger-item">
            <mat-icon>exit_to_app</mat-icon>
            <span>Quitter le groupe</span>
        </button>
    </mat-menu>

    <!-- Modal pour créer un nouveau chat -->
    <div class="modal-overlay" *ngIf="showNewChatModal" (click)="closeNewChatModal()">
        <div class="new-chat-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Nouvelle conversation</h3>
                <button mat-icon-button (click)="closeNewChatModal()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <div class="modal-content">
                <div class="chat-type-selector">
                    <button class="type-option"
                            [class.active]="newChatType === 'private'"
                            (click)="newChatType = 'private'">
                        <mat-icon>person</mat-icon>
                        <span>Chat privé</span>
                    </button>
                    <button class="type-option"
                            [class.active]="newChatType === 'group'"
                            (click)="newChatType = 'group'">
                        <mat-icon>group</mat-icon>
                        <span>Groupe</span>
                    </button>
                </div>

                <!-- Formulaire chat privé -->
                <div *ngIf="newChatType === 'private'" class="chat-form">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>ID de l'utilisateur</mat-label>
                        <input matInput [(ngModel)]="otherUserId" placeholder="Entrez l'ID utilisateur" type="number">
                        <mat-icon matSuffix>person</mat-icon>
                    </mat-form-field>
                    <button mat-raised-button color="primary"
                            (click)="createPrivateChat(); closeNewChatModal()"
                            [disabled]="!otherUserId.trim() || loading"
                            class="create-btn">
                        <mat-icon>add</mat-icon>
                        Créer le chat
                    </button>
                </div>

                <!-- Formulaire groupe -->
                <div *ngIf="newChatType === 'group'" class="chat-form">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Nom du groupe</mat-label>
                        <input matInput [(ngModel)]="groupName" placeholder="Nom du groupe">
                        <mat-icon matSuffix>group</mat-icon>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Description (optionnelle)</mat-label>
                        <input matInput [(ngModel)]="groupDescription" placeholder="Description du groupe">
                        <mat-icon matSuffix>description</mat-icon>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>IDs des participants</mat-label>
                        <input matInput [(ngModel)]="participantIds" placeholder="1, 2, 3, ...">
                        <mat-hint>Séparez les IDs par des virgules</mat-hint>
                        <mat-icon matSuffix>people</mat-icon>
                    </mat-form-field>

                    <button mat-raised-button color="primary"
                            (click)="createGroup(); closeNewChatModal()"
                            [disabled]="!groupName.trim() || loading"
                            class="create-btn">
                        <mat-icon>group_add</mat-icon>
                        Créer le groupe
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal d'édition de message -->
    <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
        <div class="edit-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Modifier le message</h3>
                <button mat-icon-button (click)="closeEditModal()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <div class="modal-content">
                <div class="edit-form">
                    <div class="message-edit-area">
                        <textarea [(ngModel)]="editedMessageContent"
                                  placeholder="Modifier votre message..."
                                  #editTextarea></textarea>
                    </div>

                    <div class="form-actions">
                        <button class="cancel-btn" (click)="closeEditModal()">
                            Annuler
                        </button>
                        <button class="save-btn"
                                (click)="saveEditedMessage()"
                                [disabled]="!editedMessageContent.trim()">
                            Enregistrer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de suppression -->
    <div class="confirmation-overlay" *ngIf="showDeleteConfirmModal" (click)="closeDeleteConfirmModal()">
        <div class="confirmation-modal" (click)="$event.stopPropagation()">
            <div class="modal-icon danger">
                <mat-icon>delete_forever</mat-icon>
            </div>

            <h3>Supprimer le message</h3>
            <p>Êtes-vous sûr de vouloir supprimer ce message ? Cette action est irréversible.</p>

            <div class="modal-actions">
                <button class="cancel-btn" (click)="closeDeleteConfirmModal()">
                    Annuler
                </button>
                <button class="confirm-btn" (click)="confirmDeleteMessage()">
                    Supprimer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de prévisualisation d'image -->
    <div class="modal-overlay" *ngIf="showImagePreview" (click)="closeImagePreview()">
        <div class="image-preview-modal" (click)="$event.stopPropagation()">
            <div class="image-preview-header">
                <h3>Aperçu de l'image</h3>
                <button mat-icon-button (click)="closeImagePreview()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <div class="image-preview-content">
                <img [src]="previewImageUrl" [alt]="previewImageName" class="preview-image">
            </div>

            <div class="image-preview-actions">
                <button mat-raised-button (click)="downloadFile(previewImageName)">
                    <mat-icon>download</mat-icon>
                    Télécharger
                </button>
            </div>
        </div>
    </div>

    <!-- Overlay pour fermer les menus -->
    <div class="menu-overlay" *ngIf="showMenuFor" (click)="showMenuFor = null"></div>
</div>