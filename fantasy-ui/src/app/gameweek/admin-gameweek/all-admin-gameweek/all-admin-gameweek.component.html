<h3 class="subtitle">Liste des gameweeks</h3>

<!-- Modal backdrop -->
<div class="modal-backdrop" *ngIf="selectedGameweekForMatches" (click)="closeMatchesModal()"></div>

<!-- Modal content -->
<div class="modal" *ngIf="selectedGameweekForMatches" role="dialog" aria-modal="true">
  <app-show-gameweek-matches
    [gameweek]="selectedGameweekForMatches"
    [matches]="matchesForSelectedGameweek"
    (matchesUpdated)="onMatchesUpdated($event)"
    (close)="closeMatchesModal()">
  </app-show-gameweek-matches>
</div>

<!-- Filters -->
<div class="filters" style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
  <label>
    Statut :
    <select [(ngModel)]="statusFilter">
      <option value="">Tous</option>
      <option *ngFor="let status of statuses" [value]="status.value">{{ status.label }}</option>
    </select>
  </label>

  <label>
    Compétition :
    <select [(ngModel)]="competitionFilter">
      <option value="">Toutes</option>
      <option *ngFor="let comp of competitions" [value]="comp.value">{{ comp.label }}</option>
    </select>
  </label>

  <button type="button" (click)="applyFilters()" class="btn-primary">Filtrer</button>
  <button type="button" (click)="resetFilters()" class="btn-secondary">Réinitialiser</button>
</div>

<!-- Table + Actions -->
<div class="gameweek-table-container">
  <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem; gap: 1rem;">
    <button class="btn-secondary" (click)="deleteSelectedGameweeks()" [disabled]="selectedGameweekIds.size === 0">
      Supprimer sélectionnés
    </button>
    <button mat-icon-button (click)="addNew()" class="col-green" matTooltip="Ajouter un gameweek">
      <mat-icon>add_circle_outline</mat-icon>
    </button>
  </div>

  <table class="match-table">
    <thead>
      <tr>
        <th>
          <input
            type="checkbox"
            [checked]="allSelected()"
            (change)="toggleSelectAll($event)"
            aria-label="Tout sélectionner" />
        </th>
        <th>Semaine</th>
        <th>Compétition</th>
        <th>Statut</th>
        <th>Date de début</th>
        <th>Date de fin</th>
        <th>Time Left</th>
        <th>Matchs</th>
        <th>Tiebreakers</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let gameweek of getPagedData(); trackBy: trackByGameweek"
          [ngClass]="getRowClass(gameweek.status)">
        <td>
          <input
            type="checkbox"
            [checked]="selectedGameweekIds.has(gameweek.id!)"
            (change)="onSelectionChange(gameweek, $event)"
            aria-label="Sélectionner" />
        </td>
        <td>{{ gameweek.weekNumber }}</td>
        <td>{{ formatCompetition(gameweek.competition) }}</td>
        <td>
          <span [class]="getStatusClass(gameweek.status)">
            {{ gameweek.status }}
          </span>
        </td>
        <td>{{ gameweek.startDate | date: 'dd/MM/yyyy HH:mm' }}</td>
        <td>{{ gameweek.endDate | date: 'dd/MM/yyyy HH:mm' }}</td>
        <td class="deadline-timer" *ngIf="gameweek.joinDeadline">
          {{ getTimeLeft(gameweek.joinDeadline) }}
        </td>
        <td>
          <span class="badge matches-count" 
                [class.bg-success]="getMatchesCount(gameweek) > 0"
                [class.bg-secondary]="getMatchesCount(gameweek) === 0"
                [title]="getMatchesCount(gameweek) + ' match(s) dans cette gameweek'">
            {{ getMatchesCount(gameweek) }}
          </span>
        </td>
        <td>
          <span class="badge tiebreaker-count"
                [class.bg-warning]="getTiebreakerCount(gameweek) > 0"
                [class.bg-light]="getTiebreakerCount(gameweek) === 0"
                [title]="getTiebreakerCount(gameweek) + ' match(s) tiebreaker'">
            {{ getTiebreakerCount(gameweek) }}
          </span>
        </td>
        <td class="actions">
          <!-- Modifier -->
          <button 
            mat-icon-button 
            class="btn-icon blue" 
            [routerLink]="['/admin/gameweek/Editgameweek', gameweek.id]"
            matTooltip="Modifier" 
            aria-label="Modifier">
            <mat-icon>edit</mat-icon> 
          </button>

          <!-- Supprimer -->
          <button
            mat-icon-button
            class="btn-icon red"
            (click)="deleteGameweek(gameweek.id!)"
            matTooltip="Supprimer"
            aria-label="Supprimer">
            <mat-icon>delete_outline</mat-icon>
          </button>

          <!-- Voir les matchs -->
          <button
            mat-icon-button
            class="btn-icon green"
            (click)="showMatches(gameweek)"
            matTooltip="Voir les matchs"
            aria-label="Voir les matchs">
            <mat-icon>sports_soccer</mat-icon>
          </button>

          <!-- Ajouter des matchs -->
          <button
            mat-icon-button
            class="btn-icon blue"
            (click)="selectMatches(gameweek.id!)"
            matTooltip="Ajouter des matchs"
            aria-label="Ajouter des matchs">
            <mat-icon>add_circle_outline</mat-icon>
          </button>

          <!-- Réinitialiser -->
          <button
            mat-icon-button
            class="btn-icon orange"
            (click)="resetGameweek(gameweek.id!)"
            matTooltip="Réinitialiser Gameweek"
            aria-label="Réinitialiser tous les matchs">
            <mat-icon>autorenew</mat-icon>
          </button>
        </td>
      </tr>

      <!-- No result row -->
      <tr *ngIf="dataSource.filteredData.length === 0">
        <td colspan="10" class="text-center text-muted py-4">
          Aucune gameweek trouvée
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Paginator placed outside tbody -->
  <mat-paginator
    [length]="dataSource.filteredData.length"
    [pageSize]="10"
    [pageSizeOptions]="[10, 19, 38, 300]"
    showFirstLastButtons>
  </mat-paginator>
</div>