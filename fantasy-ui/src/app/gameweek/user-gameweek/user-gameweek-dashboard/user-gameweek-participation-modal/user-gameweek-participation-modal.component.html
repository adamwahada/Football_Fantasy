<!-- user-gameweek-participation-modal.component.html - Cleaned version with buy-in preserved -->
<div class="modal-overlay" *ngIf="isVisible" (click)="onOverlayClick($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Rejoindre une Comp√©tition</h2>
      <button class="close-btn" (click)="closeModal()" [disabled]="isLoading">&times;</button>
    </div>

    <!-- Error Display Section -->
    <div *ngIf="errorDisplay.show" [ngClass]="'error-display-container ' + errorDisplay.type" class="error-container">
      <div class="error-header">
        <span class="error-icon">{{ getErrorIcon() }}</span>
        <strong class="error-title">{{ errorDisplay.message }}</strong>
      </div>

      <!-- Suggestions Section -->
      <div *ngIf="errorDisplay.suggestions && errorDisplay.suggestions.length > 0" class="suggestions-section">
        <h4>Suggestions:</h4>
        <ul class="suggestions-list">
          <li *ngFor="let suggestion of errorDisplay.suggestions" class="suggestion-item">
            {{ suggestion }}
          </li>
        </ul>
      </div>

      <!-- Retry/Close Button for Error Actions -->
      <div class="error-actions">
        <button *ngIf="errorDisplay.canRetry" 
                type="button" 
                class="btn-retry" 
                (click)="clearError()"
                [disabled]="isLoading">
          Modifier et r√©essayer
        </button>
        <button *ngIf="!errorDisplay.canRetry" 
                type="button" 
                class="btn-close-error" 
                (click)="closeModal()"
                [disabled]="isLoading">
          Fermer
        </button>
      </div>
    </div>

    <!-- Main Form -->
    <form [formGroup]="participationForm" (ngSubmit)="onSubmit()" 
          *ngIf="!errorDisplay.show || errorDisplay.canRetry">
      
      <div class="form-group">
        <label for="sessionType">Type de Session:</label>
        <select id="sessionType" formControlName="sessionType" class="form-control" [disabled]="isLoading">
          <option value="">S√©lectionner un type</option>
          <option value="ONE_VS_ONE">1 vs 1</option>
          <option value="SMALL_GROUP">Best of 5</option>
          <option value="MEDIUM_GROUP">Best of 10</option>
          <option value="OPEN_ROOM">Open Room</option>
        </select>
        <div class="error-message" *ngIf="participationForm.get('sessionType')?.invalid && participationForm.get('sessionType')?.touched">
          Veuillez s√©lectionner un type de session
        </div>
      </div>

      <!-- Buy-in Amount Selection -->
      <div class="buy-in-section">
        <label class="section-label">Montant de mise</label>
        <div class="buy-in-options">
          <button 
            *ngFor="let amount of buyInOptions" 
            type="button"
            [ngClass]="{'active': selectedBuyIn === amount}"
            [disabled]="isLoading || !isAmountAffordable(amount)"
            (click)="onBuyInClick(amount)"
            [attr.title]="!isAmountAffordable(amount) ? 'Solde insuffisant pour ce montant' : ''">
            <span class="amount">{{ amount.toFixed(2) }}‚Ç¨</span>
            <span *ngIf="selectedBuyIn === amount" class="selected-indicator">‚úì</span>
          </button>
        </div>

        <!-- Selected Amount Display -->
        <div class="selected-amount-display" *ngIf="selectedBuyIn > 0">
          Montant s√©lectionn√©: <strong>{{ selectedBuyIn.toFixed(2) }}‚Ç¨</strong>
          <span *ngIf="!isAmountAffordable(selectedBuyIn)" class="unaffordable-indicator">‚ö†Ô∏è Solde insuffisant</span>
        </div>
      </div>

      <!-- Private session section (always visible) -->
      <div class="private-session-card">
        <div class="private-header">
          <div class="private-title">
            <span class="lock-icon">üîí</span>
            <div class="title-text">
              <strong>Session priv√©e</strong>
              <small>Invitez des amis avec une cl√© d'acc√®s</small>
            </div>
          </div>
          <label class="switch-label">
            <input type="checkbox" formControlName="isPrivate" [disabled]="isLoading">
            <span>Activer</span>
          </label>
        </div>

        <div class="private-body" *ngIf="participationForm.get('isPrivate')?.value">
          <!-- Private mode radios inline -->
          <div class="form-group">
            <label>Mode priv√©:</label>
            <div class="radio-group inline">
              <label class="radio-item">
                <input type="radio" formControlName="privateMode" value="CREATE" name="privateMode" [disabled]="isLoading">
                <span>Cr√©er une cl√© et inviter</span>
              </label>
              <label class="radio-item">
                <input type="radio" formControlName="privateMode" value="JOIN" name="privateMode" [disabled]="isLoading">
                <span>Rejoindre avec une cl√©</span>
              </label>
            </div>
          </div>

          <!-- CREATE mode: show client-generated key and actions -->
          <div class="form-group" *ngIf="participationForm.get('privateMode')?.value === 'CREATE'">
            <label>Cl√© d'acc√®s:</label>
            <div class="generated-key-box">
              <input #generatedKeyInput type="text" class="generated-key-input" [value]="generatedAccessKey" readonly (click)="selectGeneratedKey(generatedKeyInput)">
              <div class="key-actions">
                <button type="button" class="btn btn-light" (click)="regenerateAccessKey()" [disabled]="isLoading">R√©g√©n√©rer</button>
                <button type="button" class="btn btn-light" (click)="copyGeneratedKeyToClipboard()" [disabled]="isLoading">Copier</button>
              </div>
            </div>
            <small>Cette cl√© sera utilis√©e pour cr√©er la session priv√©e.</small>
          </div>

          <!-- JOIN mode: input for access key -->
          <div class="form-group" *ngIf="participationForm.get('privateMode')?.value === 'JOIN'">
            <label for="accessKey">Cl√© d'acc√®s:</label>
            <input type="text"
                   id="accessKey"
                   formControlName="accessKey"
                   class="form-control"
                   [disabled]="isLoading"
                   placeholder="Entrez la cl√© d'acc√®s">
            <div class="error-message" *ngIf="participationForm.get('accessKey')?.invalid && participationForm.get('accessKey')?.touched">
              La cl√© d'acc√®s est requise pour rejoindre une session priv√©e
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" 
                class="btn btn-secondary" 
                (click)="closeModal()" 
                [disabled]="isLoading">
          Annuler
        </button>
        <button type="submit"
                class="btn btn-primary"
                [disabled]="participationForm.invalid || isLoading || selectedBuyIn <= 0 || !isAmountAffordable(selectedBuyIn) || !hasAnyAffordableAmount()">
          <span *ngIf="isLoading" class="spinner"></span>
          {{ isLoading ? 'Traitement...' : 'Confirmer et Rejoindre' }}
        </button>
      </div>
    </form>

    <!-- Alternative: Show only error message for non-retryable errors -->
    <div *ngIf="errorDisplay.show && !errorDisplay.canRetry && errorDisplay.type !== 'success'" 
         class="error-only-content">
      <div class="error-only-message">
        <p>{{ errorDisplay.message }}</p>
        <div *ngIf="errorDisplay.suggestions && errorDisplay.suggestions.length > 0">
          <h4>Que faire:</h4>
          <ul>
            <li *ngFor="let suggestion of errorDisplay.suggestions">{{ suggestion }}</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div *ngIf="isLoading" class="loading-overlay">
      <div class="loading-spinner">
        <div class="spinner-ring"></div>
        <p>Traitement en cours...</p>
      </div>
    </div>
  </div>
</div>
